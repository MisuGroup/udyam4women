<!DOCTYPE html>
<html>
<head>
  <title>Lucky Draw</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 20px;
    }
    #randomizer {
      font-size: 24px;
      margin: 20px 0;
    }
    .winner {
      font-weight: bold;
      color: green;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <h1>Lucky Draw</h1>
  
  <!-- Timer Section -->
  <h2>Time Remaining</h2>
  <div id="timer">Loading...</div>

  <!-- Randomizer Section -->
  <h2>Spin the Wheel</h2>
  <div id="randomizer">Click "Search" to check your Udyam number.</div>
  <input type="text" id="udyamSearch" placeholder="Enter Udyam Number">
  <button onclick="searchUdyam()">Search</button>

  <!-- Winner List -->
  <h2>Winners</h2>
  <div id="winnerList">Loading...</div>

<script>
  const apiUrl = "https://script.google.com/macros/s/AKfycbwS0PiCg6hx5iMn1NhqD1pmhd-h5IdDyQyGDPBaCIbfEVFgUvh6cc6S0M8EWZB6j1Tx-w/exec";

  // Timer function
  function startTimer(endTime) {
    const timer = document.getElementById("timer");
    const interval = setInterval(() => {
      const now = new Date().getTime();
      const distance = endTime - now;
      if (distance <= 0) {
        clearInterval(interval);
        timer.innerHTML = "The draw is happening now!";
        return;
      }
      const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);
      timer.innerHTML = `Time left: ${hours}h ${minutes}m ${seconds}s`;
    }, 1000);
  }

  // Fetch lucky draw data and start timer
  async function fetchLuckyDrawData() {
    try {
      const response = await fetch(`${apiUrl}?action=getLuckyDrawData`);
      const result = await response.json();
      if (result.status === "success" && result.data.length > 0) {
        const draw = result.data[0]; // Assuming the first draw for now
        const drawDateTime = new Date(`${draw.drawDate} ${draw.drawTime}`);
        startTimer(drawDateTime.getTime());
      } else {
        document.getElementById("timer").innerText = "No upcoming draws.";
      }
    } catch (error) {
      console.error("Error fetching lucky draw data:", error);
      document.getElementById("timer").innerText = "Failed to load draw details.";
    }
  }

  // Search Udyam Number
  async function searchUdyam() {
    const udyamNumber = document.getElementById("udyamSearch").value.trim();
    if (!udyamNumber) {
      alert("Please enter a valid Udyam number.");
      return;
    }

    try {
      const response = await fetch(`${apiUrl}?action=getUdyamSearch&udyamNumber=${encodeURIComponent(udyamNumber)}`);
      const result = await response.json();

      if (result.status === "success") {
        document.getElementById("randomizer").innerHTML = `<p class="winner">Congratulations! Udyam ${udyamNumber} is eligible for the draw.</p>`;
      } else {
        document.getElementById("randomizer").innerHTML = `<p class="error">${result.message}</p>`;
      }
    } catch (error) {
      console.error("Error searching Udyam number:", error);
      document.getElementById("randomizer").innerHTML = `<p class="error">Failed to search for Udyam number.</p>`;
    }
  }

  // Fetch Winners - Updated with AJAX
  function fetchWinners() {
    const xhr = new XMLHttpRequest();
    xhr.open("GET", `${apiUrl}?action=getPastResults`, true);
    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {
          try {
            const response = JSON.parse(xhr.responseText);
            console.log(response);
            const winnerListDiv = document.getElementById("winnerList");

            if (response.status === "success" && response.data.length > 0) {
              // Render the winner data
              const winners = response.data.map(winner => `
                <div>
                  <p><strong>Draw:</strong> ${winner["draw number"] || "N/A"}</p>
                  <p><strong>Winner:</strong> ${winner["Account holder name"] || "N/A"} (${winner["udyam number"] || "N/A"})</p>
                </div>
              `);

              winnerListDiv.innerHTML = winners.join("");
            } else {
              winnerListDiv.innerHTML = "<p>No winners yet.</p>";
            }
          } catch (error) {
            console.error("Error parsing winners response:", error);
            document.getElementById("winnerList").innerHTML = "<p>Failed to load winners.</p>";
          }
        } else {
          console.error("Error fetching winners:", xhr.statusText);
          document.getElementById("winnerList").innerHTML = "<p>Failed to load winners.</p>";
        }
      }
    };
    xhr.send();
  }

  // Load Winners on Page Load
  fetchWinners();
</script>

</body>
</html>
